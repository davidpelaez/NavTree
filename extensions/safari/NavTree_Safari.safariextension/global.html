<!DOCTYPE HTML> 
<script src="jquery162.js" type="text/javascript"></script>
<script src="TabsTable.js" type="text/javascript"></script>
<script src="NavTreeTab.js" type="text/javascript"></script>
<script> 

NAVTREE_SERVER = "http://localhost:3000"; //NEVER ADD Trailing Sladge /  

var date = new Date();

//Data structure to keep record of the tree and sync with the server
var tabsTable = new TabsTable();

//Event tracking
safari.application.addEventListener("open", tabsTable.openHandler, true); 
safari.application.addEventListener("close", tabsTable.closeHandler, true); 
safari.application.addEventListener("beforeNavigate", tabsTable.navigationHandler, true);  //Record the intention to go somewhere

window.onload = function(){
	//Add all tabs. No duplicated are added because add manages that case. This is for simpler testing. 
	//Navigation happens on reaload but not the events of open, that's why this method is added
	windows = safari.application.browserWindows;
	for(var i=0; i< windows.length;i++){
		for(var j=0;j<windows[i].tabs.length;j++){
			tabsTable.addTab(windows[i].tabs[j]);
		}
	}
	console.log("Unsynced NavTreeTabs = " + tabsTable.findUnsyncedNavTreeTabs().length);
};   


function randomString(len, charSet) {
    charSet = charSet || 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var randomString = '';
    for (var i = 0; i < len; i++) {
        var randomPoz = Math.floor(Math.random() * charSet.length);
        randomString += charSet.substring(randomPoz,randomPoz+1);
    }
    return randomString;
};

var ajaxHeaders = new Object();
ajaxHeaders.rulos = "ALOHA";

//Set default AJAX settings
jQuery.ajaxSetup({
	type: 'POST',
  	url: NAVTREE_SERVER + "/tests",  
	headers: ajaxHeaders,
	datatype: "json",   	
	beforeSend: function(jqXHR){
		jqXHR.setRequestHeader("Rest-Authorization-Code", 33333333);
		jqXHR.setRequestHeader("secret",safari.extension.secureSettings.secretKey);
		},
	data: "test=1",
 });


</script>
