<!DOCTYPE HTML> 
<script src="lib/jquery162.js" type="text/javascript" charset="utf-8"></script>
<script src="lib/Base64.js" type="text/javascript" charset="utf-8"></script>
<script src="js/TabsTable.js" type="text/javascript" charset="utf-8"></script>
<script src="js/buttonManager.js" type="text/javascript" charset="utf-8"></script>
<script src="js/handlers.js" type="text/javascript" charset="utf-8"></script>
<script src="js/NavTreeTab.js" type="text/javascript" charset="utf-8"></script>

<script> 

NAVTREE_SERVER = "http://growanavtree.com"; //NEVER ADD Trailing Sladge /  

var date = new Date();  
var okSyncs = 0;  //Count how many oks have been done                                                       
var extensionMode = 0; //This is to control to enable/disable the extension or inform that there's a problem

//Data structure to keep record of the tree and sync with the server
var tabsTable = new TabsTable();

//Event tracking
safari.application.addEventListener("open", openHandler, true); 
safari.application.addEventListener("close", closeHandler, true); 
safari.application.addEventListener("command", commandHandler, false);
safari.application.addEventListener("beforeNavigate", navigationHandler, true);  //Record the intention to go somewhere
safari.extension.toolbarItems[0].__proto__.status = 0; //Make the button in the toolbar have a status



window.onload = function(){
	//Add all tabs. No duplicated are added because add manages that case. This is for simpler testing. 
	//Navigation happens on reaload but not the events of open, that's why this method is added
	windows = safari.application.browserWindows;
	for(var i=0; i< windows.length;i++){
		for(var j=0;j<windows[i].tabs.length;j++){
			tabsTable.addTab(windows[i].tabs[j]);
		}
	}
};   


function randomString(len, charSet) {
    charSet = charSet || 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var randomString = '';
    for (var i = 0; i < len; i++) {
        var randomPoz = Math.floor(Math.random() * charSet.length);
        randomString += charSet.substring(randomPoz,randomPoz+1);
    }
    return randomString;
};


//Set default AJAX settings
jQuery.ajaxSetup({
	type: 'POST',
  	url: NAVTREE_SERVER + "/edges",  
	datatype: "json",
	//contentType: "application/json; charset=utf-8",   	
	beforeSend: function(jqXHR){
		jqXHR.setRequestHeader("x-secret",safari.extension.secureSettings.secretKey);
		},
	data: "test=1",
 });

/*
 * MESSAGE INTERACTION WITH THE POPOVER
 */

function respondToMessage(theMessageEvent) {
	alert("MSG!");
    if(theMessageEvent.name === "changeStatus")
    {
		console.log("Updating status to " + theMessageEvent.message);
		toolbarButton.setStatus(theMessageEvent.message);
    }
    if(theMessageEvent.name === "console")
    {
		console.log(theMessageEvent.message);
    }
}

safari.application.addEventListener("message",respondToMessage,false);


</script>
